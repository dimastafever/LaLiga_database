# LaLiga_database

Проект представляет собой базу данных для учета и анализа данных о футбольном чемпионате Испании (La Liga). База данных включает информацию о командах, игроках, матчах, тренерах, стадионах и статистике игроков.

[Работа с API для получения актуальных данных о футбольном чемпионате Испании](api_with_py.md)  
[Приложение для взаимодействия с базой данных](LaLiga_QT.md)

## 1. Настройка базы данных

### Требования
- PostgreSQL 15.0 или выше
- Доступ к серверу PostgreSQL с правами создания базы данных

### Порядок выполнения SQL файлов
1. **la_liga.sql** - Создание схемы базы данных, таблиц, ограничений, индексов, триггеров и хранимых процедур
2. **inserts.sql** - Заполнение таблиц тестовыми данными (команды, игроки, стадионы, тренеры, матчи, статистика игроков)
3. **requests.sql** - Создание представлений, дополнительных запросов и процедур

### Пример подключения
```sql
-- Создание базы данных
CREATE DATABASE la_liga
    ENCODING = 'UTF8'
    LC_COLLATE = 'ru_RU.UTF-8'
    LC_CTYPE = 'ru_RU.UTF-8'
    TABLESPACE = pg_default
    OWNER = postgres;

-- Подключение к базе данных
\c la_liga
```

## 2. Описание структуры базы данных

База данных "La Liga" предназначена для комплексного учета и анализа данных о футбольном чемпионате Испании. Она может использоваться:

1. **Администрацией La Liga**
2. **Командами и тренерами**
3. **СМИ и аналитиками**
4. **Болельщиками и фанатами**

### Проверочные ограничения (CHECK constraints):

1. Год основания команды между 1800 и текущим годом (`year_ch`)
2. Очки команды не могут быть отрицательными (`points_ch`)
3. Вместимость стадиона должна быть положительной (`capacity_ch`)
4. Дата рождения тренера после 1900 года (`data_ch`)
5. Посещаемость матча не может быть отрицательной (`attendance_ch`)
6. Номер тура в диапазоне 1-38 (`round_number`)
7. Голы и передачи не могут быть отрицательными (`goals_ch`, `assists_ch`)
8. Счет матчей не может быть отрицательным (`matches_home_team_score_check`, `matches_away_team_score_check`)

### Уникальные ограничения:

1. Уникальный `player_id` в таблице статистики
2. Уникальные идентификаторы во всех таблицах

### Возможные запросы пользователей

#### Аналитические запросы:
1. Текущая турнирная таблица
2. Рейтинг лучших бомбардиров
3. Статистика посещаемости по стадионам
4. Эффективность команд в домашних/выездных матчах
5. Распределение игроков по национальностям и позициям

#### Операционные запросы:
1. Добавление результатов матчей
2. Обновление статистики игроков
3. Регистрация новых игроков и тренеров
4. Корректировка турнирной таблицы

## 2. Схема базы данных

![alt text](images/Scheme.png)

## 3. Список созданных запросов с их описанием

1. **Топ-5 бомбардиров лиги** - Отображает лучших бомбардиров чемпионата
2. **Турнирная таблица** - Показывает текущее положение команд в чемпионате
3. **Количество игроков по странам** - Статистика распределения игроков по национальностям
4. **Самые посещаемые матчи** - Рейтинг матчей по посещаемости
5. **Игроки с наибольшим количеством матчей** - Статистика участия игроков в матчах
6. **Матчи с наибольшей разницей в счете** - Матчи с самым крупным счетом
7. **Команды по году основания** - Сортировка команд по дате основания
8. **Игроки без статистики** - Поиск игроков без статистических данных
9. **Тренеры и их команды** - Связь тренеров с командами
10. **Стадионы по вместимости** - Рейтинг стадионов по вместимости
11. **Распределение игроков по позициям** - Статистика по игровым позициям
12. **Матчи по турам** - Группировка матчей по турам чемпионата
13. **Команды с наибольшим количеством игроков** - Статистика численности составов
14. **Игроки с красными карточками** - Дисциплинарная статистика
15. **Домашняя статистика команд** - Результаты команд на домашнем стадионе
16. **Голы в среднем за матч по командам** - Атакующая эффективность команд
17. **Полная статистика матчей** - Детальная информация о матчах
18. **Эффективность игроков (голы+пас)** - Комбинированный показатель эффективности
19. **Все русские игроки** - Фильтрация игроков по национальности (Россия)
20. **Все игроки Барселоны и Реал Мадрида** - Составы топ-команд
21. **Тренеры по национальностям** - Распределение тренеров по странам
22. **Команды из определённого города** - Поиск команд по городу

## 4. Список созданных процедур, функций, представлений, триггеров

### Представления:
1. **top_scorers** - Топ-5 бомбардиров лиги
2. **league_standings** - Турнирная таблица

### Триггер:
- **trigger_calculate_points** - Автоматический расчет total_points
  - **Таблица:** `player_stats`
  - **Функция:** `calculate_player_points()`
  - **Логика:** При вставке или обновлении автоматически вычисляет `total_points = goals + assists`
  - **Проверка:** Если результат отрицательный, устанавливается в 0

### Хранимые процедуры:
1. **add_points_to_team(team_id_input INTEGER, points_to_add INTEGER)**
   - Назначение: Добавление очков команде
   - Логика: Обновляет поле `points` в таблице `teams`, выводит уведомление

2. **count_team_players(team_id_input INTEGER)**
   - Назначение: Подсчет количества игроков в команде
   - Логика: Выводит название команды и количество игроков

3. **count_goals_in_round(round_number_input INTEGER)**
   - Назначение: Подсчет общего количества голов в туре
   - Логика: Суммирует домашние и выездные голы за указанный тур

4. **show_team_stadium(team_id_input INTEGER)**
   - Назначение: Показ информации о стадионе команды
   - Логика: Выводит название стадиона, вместимость и город

5. **add_new_player(player_name_input VARCHAR, position_input VARCHAR, nationality_input VARCHAR, team_id_input INTEGER)**
   - Назначение: Добавление нового игрока
   - Логика: Генерирует новый `player_id`, вставляет запись в таблицу `players`

## 5. Рекомендации по работе с базой данных – оптимизация с помощью индексов

### Индексы для оптимизации производительности:

#### `idx_players_team_id` - Индекс по полю `team_id` в таблице `players`
- Ускоряет поиск игроков по команде
- Оптимизирует JOIN операции между `teams` и `players`

#### `idx_players_position` - Индекс по полю `position` в таблице `players`
- Ускоряет фильтрацию игроков по позиции
- Полезен для запросов типа "все нападающие"

#### `idx_players_nationality` - Индекс по полю `nationality` в таблице `players`
- Оптимизирует поиск игроков по национальности
- Ускоряет агрегатные запросы по странам
